<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RashtraSetu - Issue Tracker</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f7f9fc;
      }

      /* Header Background */
      /* FIXED & IMPROVED SEARCH BAR */
      .header-search {
        background: url("images/issTracker_img.jpeg") no-repeat center/cover;
        height: 250px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 20px;
      }

      .search-box {
        display: flex;
        align-items: center;
        width: 70%;
        max-width: 700px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        padding: 5px;
      }

      .search-box input {
        flex: 1;
        padding: 14px;
        border: none;
        font-size: 16px;
        outline: none;
        border-radius: 50px;
        background: transparent;
      }

      .search-box button {
        padding: 12px 25px;
        border: none;
        background: #007bff;
        color: white;
        font-size: 16px;
        border-radius: 50px;
        cursor: pointer;
        transition: 0.3s;
      }

      .search-box button:hover {
        background: #005fcc;
      }

      /* ICON FIX */
      .search-box i {
        margin-left: 12px;
        margin-right: 5px;
        color: #007bff;
      }

      /* Filter Section */
      .filter-section {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
      }

      /* Issue Cards */
      .issue-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        transition: transform 0.2s;
      }
      .issue-card:hover {
        transform: translateY(-5px);
      }
      .status-open {
        color: #ff4d4d;
        font-weight: bold;
      }
      .status-progress {
        color: #ffa500;
        font-weight: bold;
      }
      .status-resolved {
        color: #28a745;
        font-weight: bold;
      }

      .issue-card .detail {
        font-size: 14px;
        color: #555;
      }
      .collapse.show {
        margin-top: 10px;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .header-search input {
          width: 80%;
        }
      }
    </style>
  </head>
  <body>
    <script>
      let issues = [];
      window.onload = async () => {
        const res = await fetch("https://viraj-backend.onrender.com/api/all-issues");
        issues = (await res.json()).issues;
        const issueContainer = document.getElementById("issuesContainer");
        issueContainer.innerHTML = issues.map(renderCard).join("");
      };
const renderCard = (issue) => {
  return `
    <div
      class="col-md-6 issue-card"
      data-status="${issue.status.toLowerCase()}"
      data-pincode="${issue.pincode}"
      data-date="${issue.createdAt}"
    >
      <h5>Issue ID: #${issue.id}</h5>

      <p class="detail"><strong>Title:</strong> ${issue.title}</p>

      <p class="detail">
        <strong>Status:</strong>
        <span class="status-${issue.status.toLowerCase()}">
          ${issue.status.replace("_", " ").toUpperCase()}
        </span>
      </p>

      <p class="detail"><strong>Pincode:</strong> ${issue.pincode}</p>

      <p class="detail"><strong>Description:</strong> ${issue.desc}</p>

      <p class="detail">
        <strong>Date:</strong>
        ${new Date(issue.createdAt).toLocaleString()}
      </p>
    </div>
  `;
};

    </script>

    <!-- Header & Search -->
    <div class="header-search">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input id="searchInput" type="text" placeholder="Search Issue by ID" />
        <button onclick="applyFilters()">Search</button>
      </div>
    </div>

    <div class="container my-5">
      <!-- Page Title -->
      <h2 class="text-center mb-5">Issue Tracker</h2>

      <!-- Filter Section -->
     <div class="filter-section row g-3 align-items-end">
  <!-- Status -->
  <div class="col-md-4">
    <label class="form-label">Status</label>
    <select id="statusFilter" class="form-select" onchange="applyFilters()">
  <option value="">ALL</option>
  <option value="OPEN">OPEN</option>
  <option value="INPROGRESS">IN PROGRESS</option>
  <option value="RESOLVED">RESOLVED</option>
</select>

  </div>

  <!-- Pincode -->
  <div class="col-md-4">
    <label class="form-label">Pincode</label>
    <input
      type="text"
      id="pincodeFilter"
      class="form-control"
      placeholder="Enter pincode"
      onkeyup="applyFilters()"
    />
  </div>

  <!-- Date Sort -->
  <div class="col-md-4">
    <label class="form-label">Sort by Date</label>
    <select id="dateSort" class="form-select" onchange="applyFilters()">
      <option value="recent">Recent First</option>
      <option value="older">Older First</option>
    </select>
  </div>
</div>


      <!-- Issue Cards Section -->
      <div class="row mt-4" id="issuesContainer">
      
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Filter & Search Function
      function filterIssues() {
  const status = document
    .getElementById("statusFilter")
    .value.toLowerCase();

  const cards = document.querySelectorAll(".issue-card");

  cards.forEach(card => {
    const cardStatus = card.dataset.status;
    const match = !status || cardStatus === status;
    card.style.display = match ? "block" : "none";
  });
}



function applyFilters() {
  const statusValue = document
    .getElementById("statusFilter")
    .value
    .toUpperCase();

  const pincodeValue = document
    .getElementById("pincodeFilter")
    .value
    .trim();

  const idQuery = document
    .getElementById("searchInput")
    .value
    .trim()
    .toLowerCase();

  const dateSort = document.getElementById("dateSort").value;

  let filtered = [...issues];

  // ✅ FILTER BY STATUS (ALL CAPS)
  if (statusValue && statusValue !== "ALL") {
    filtered = filtered.filter(
      (i) => i.status.toUpperCase() === statusValue
    );
  }

  // ✅ FILTER BY PINCODE
  if (pincodeValue) {
    filtered = filtered.filter((i) =>
      i.pincode.includes(pincodeValue)
    );
  }

  // ✅ SEARCH BY ISSUE ID (partial UUID supported)
  if (idQuery) {
    filtered = filtered.filter((i) =>
      i.id.toLowerCase().includes(idQuery)
    );
  }

  // ✅ SORT BY DATE
  filtered.sort((a, b) => {
    const dateA = new Date(a.createdAt);
    const dateB = new Date(b.createdAt);
    return dateSort === "recent"
      ? dateB - dateA
      : dateA - dateB;
  });

  // ✅ RE-RENDER
  document.getElementById("issuesContainer").innerHTML =
    filtered.length
      ? filtered.map(renderCard).join("")
      : "<p class='text-center'>No issues found</p>";
}

    </script>
  </body>
</html>
